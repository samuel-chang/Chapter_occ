---
title: "T_ornatus_EC-vignette"
author: "Samuel Chang"
date: "3/5/2020"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{T_ornatus_EC-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEnECding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  ECmment = "#>"
)
```


# 1. Load the occUncertain R package and small occurrence data set for T.ornatus in Ecuador
```{r}
library(occUncertain)
library(ConR)

load("../data/T_ornatus/Tremarctos_ornatus.rda")

full <-
  dplyr::select(Tremarctos_ornatus,
    decimalLatitude,
    decimalLongitude,
    species)

data(land)
full.IUCN <- IUCN.eval(full, exclude.area = T, write_results = F, DrawMap = TRUE, file_name="full_results")
full.EOO <- full.IUCN$EOO #-->385341.9
full.AOO <- full.IUCN$AOO #-->1248

full <-
  dplyr::select(Tremarctos_ornatus,
    decimalLatitude,
    decimalLongitude,
    coordinateUncertaintyInMeters,
    species)

summary(full$coordinateUncertaintyInMeters)
```

# 2. meters_to_decdeg function
```{r uncertainty from meter to radian degrees}
#NA as Zero
full_naZero <-
  meters_to_decdeg(
    full,
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    distance = "coordinateUncertaintyInMeters",
    na_action = "NA as 0"
  )

full_naZero <-
  cbind(full, full_naZero)

full_naZero <- dplyr::select(
  full_naZero,
  decimalLatitude,
  decimalLongitude,
  lon_uncertainty,
  lat_uncertainty,
  species
)
  
#NA as Mean
full_naMean <-
  meters_to_decdeg(
    full,
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    distance = "coordinateUncertaintyInMeters",
    na_action = "NA as mean"
  )

full_naMean <-
  cbind(full, full_naMean)

full_naMean <- dplyr::select(
  full_naMean,
  decimalLatitude,
  decimalLongitude,
  lon_uncertainty,
  lat_uncertainty,
  species
)

#NA as NA
full_naNA <-
  meters_to_decdeg(
    full,
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    distance = "coordinateUncertaintyInMeters",
    na_action = "NA as NA"
  )

full_naNA <-
  cbind(full, full_naNA)

#removes the NA cells to use function random_geo_range with uses lat/lon uncertainty
full_naNA <-
  dplyr::filter(full_naNA,!is.na(coordinateUncertaintyInMeters))

full_naNA <- dplyr::select(
  full_naNA,
  decimalLatitude,
  decimalLongitude,
  lon_uncertainty,
  lat_uncertainty,
  species
)
```

# 3. Using the random occurrences in land metrics with random_geo_range

## `NA as Mean`
```{r naMean_geo_range}
#1000 
#---- 
naMean_geo_range_1000 <-
  random_geo_range(
    1000,
    full_naMean,
    taxa_col = "species",
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    lon_uncertainty = "lon_uncertainty",
    lat_uncertainty = "lat_uncertainty",
    country_map = land,
    exclude.area = T
  )
naMean_geo_range_1000$NA_action <- "NA as Mean"

#----
#100
naMean_geo_range_100 <-
  random_geo_range(
    100,
    full_naMean,
    taxa_col = "species",
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    lon_uncertainty = "lon_uncertainty",
    lat_uncertainty = "lat_uncertainty",
    country_map = land,
    exclude.area = T
  )
naMean_geo_range_100$NA_action <- "NA as Mean"

#Z-stat
#100.EOO <- #-2.626726
(full.EOO - mean(naMean_geo_range_100$EOO)) / sd(naMean_geo_range_100$EOO)

#100.AOO  <- #-101.5001
(full.AOO - mean(naMean_geo_range_100$AOO)) / sd(naMean_geo_range_100$AOO)

#EOO.1k <- ##-2.103957
(full.EOO - mean(naMean_geo_range_1000$EOO)) / sd(naMean_geo_range_1000$EOO)

#AOO.1K <-  ##-90.41973
(full.AOO - mean(naMean_geo_range_1000$AOO)) / sd(naMean_geo_range_1000$AOO)

#The test scores of the two spatial metric from the observed data is consisted with the different parameters used, indicating the influence of N number of observation with high uncertainty.  
```

## `Na as Zero`
```{r naZero_geo_range}
#1000
#----
naZero_geo_range_1000 <-
  random_geo_range(
    1000,
    full_naZero,
    taxa_col = "species",
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    lon_uncertainty = "lon_uncertainty",
    lat_uncertainty = "lat_uncertainty",
    contry_map = land,
    exclude.area = T
  )
naZero_geo_range_1000$NA_action <- "NA as Zero"

#---- 
      #100 
naZero_geo_range_100 <-
  random_geo_range(
    100,
    full_naZero,
    taxa_col = "species",
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    lon_uncertainty = "lon_uncertainty",
    lat_uncertainty = "lat_uncertainty",
    contry_map = land,
    exclude.area = T
  )
naZero_geo_range_100$NA_action <- "NA as Zero"

#Z-stat
## EOO.100 --> -1.615587
(full.EOO - mean(naZero_geo_range_100$EOO)) / sd(naZero_geo_range_100$EOO)

## AOO.100  --> -6.593672
(full.AOO - mean(naZero_geo_range_100$AOO)) / sd(naZero_geo_range_100$AOO)

## EOO.1K --> -1.675276
(full.EOO - mean(naZero_geo_range_1000$EOO)) / sd(naZero_geo_range_1000$EOO)

## AOO.1K --> -5.851768
(full.AOO - mean(naZero_geo_range_1000$AOO)) / sd(naZero_geo_range_1000$AOO)

```

## `NA as NA`
```{r naNA_geo_range}
#1000
#---- 
naNA_geo_range_1000 <-
  random_geo_range(
    1000,
    full_naNA,
    taxa_col = "species",
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    lon_uncertainty = "lon_uncertainty",
    lat_uncertainty = "lat_uncertainty",
    contry_map = land,
    exclude.area = T
  )
naNA_geo_range_1000$NA_action <- "NA as NA"

#---- 
      #100
naNA_geo_range_100 <-
  random_geo_range(
    100,
    full_naNA,
    taxa_col = "species",
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    lon_uncertainty = "lon_uncertainty",
    lat_uncertainty = "lat_uncertainty",
    contry_map = land,
    exclude.area = T
  )
naNA_geo_range_100$NA_action <- "NA as NA"

#Z-stat
## 100.EOO --> 0.9599171
(full.EOO - mean(naNA_geo_range_100$EOO)) / sd(naNA_geo_range_100$EOO)

## 100.AOO --> 161.3193
(full.AOO - mean(naNA_geo_range_100$AOO)) / sd(naNA_geo_range_100$AOO)
 
## EOO.1K --> 0.9819217
(full.EOO - mean(naNA_geo_range_1000$EOO)) / sd(naNA_geo_range_1000$EOO)

## AOO.1K--> 145.5964
(full.AOO - mean(naNA_geo_range_1000$AOO)) / sd(naNA_geo_range_1000$AOO)
```

# Save Results as CSV
```{r csv iterations}
save(naMean_geo_range_100,
    naZero_geo_range_100,
    naNA_geo_range_100, file = "../Results/full_results/full_100.rda")

save(naMean_geo_range_1000,
    naZero_geo_range_1000,
    naNA_geo_range_1000, file = "../Results/full_results/full_1000.rda")
```

```{r 100 iterations echo=FALSE, fig.width = 10, fig.height= 10}
library(ggplot2)
library(gridExtra)
library(grid)
library(ggrepel)
library(cowplot)

theme_set(theme_gray())

load("../Results/full_results/full_1000.rda")
load("../Results/full_results/full_100.rda")

full_1000georanges <- rbind(naMean_geo_range_1000,
                            naZero_geo_range_1000,
                            naNA_geo_range_1000)

full_100georanges <- rbind(naMean_geo_range_100,
                           naZero_geo_range_100,
                           naNA_geo_range_100)

EOO.1000 <-
  ggplot(full_1000georanges, aes(x = EOO, fill = as.factor(NA_action)))  +
  theme_bw() +
  scale_fill_discrete(name = "NA Parameters", guide = FALSE) +
  geom_histogram(alpha = 0.6,
                 position = 'identity') +
  geom_vline(xintercept = full.EOO, colour = "red") #observed EOO

AOO.1000 <-
  ggplot(full_1000georanges, aes(x = AOO, color = as.factor(NA_action)))  +
  theme_bw() +
  scale_color_discrete(name = "NA Parameters", guide = FALSE) +
  geom_histogram(alpha = 0.6,
                 position = 'identity') +
  geom_vline(xintercept = full.AOO, colour = "red")

EOO.100 <-
  ggplot(full_100georanges, aes(x = EOO, fill = as.factor(NA_action)))  +
  theme_bw() +
  scale_fill_discrete(name = "NA Parameters", guide = FALSE) +
  geom_histogram(alpha = 0.6,
                 position = 'identity') +
  geom_vline(xintercept = full.EOO, colour = "red") #observed EOO

AOO.100 <-
  ggplot(full_100georanges, aes(x = AOO, fill = as.factor(NA_action)))  +
  theme_bw() +
  scale_fill_discrete(name = "NA Parameters") +
  geom_histogram(alpha = 0.6,
                 position = 'identity') +
  geom_vline(xintercept = full.AOO, colour = "red")


full_plot <-
  plot_grid(
    EOO.100,
    AOO.100,
    EOO.1000,
    AOO.1000,
    ncol = 2,
    rel_widths = c(1, 1.6),
    aling = 'vh',
    labels = c("A", "B", "C", "D")
  )

legend <- get_legend(# create some space to the left of the legend
  full_plot + theme(legend.box.margin = margin(0, 0, 12)))

cowplot::ggsave(
  filename = "Results/full_results/full_plot_grid.png",
  width = 8,
  height = 4,
  units = "in",
  dpi = 96
)

  
```

