---
title: "T_ornatus_small_EC-vignette"
author: "Samuel Chang"
date: "3/5/2020"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{T_ornatus_small_EC-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEnECding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  ECmment = "#>"
)
```


# 1. Load the occUncertain R package and small occurrence data set for T.ornatus in Ecuador
```{r}
library(occUncertain)
library(ConR)

load("../data/T_ornatus/T_ornatus_Ec.rda")

small_observed <-
  dplyr::select(T_ornatus_Ec,
                decimalLatitude,
                decimalLongitude,
                species)

summary(small_observed$coordinateUncertaintyInMeters)


data(land)
small.IUCN <-
  IUCN.eval(
    small_observed,
    country_map = land,
    exclude.area = T,
    write_results = F,
    DrawMap = TRUE,
    file_name = "EC_results"
  )
small.EOO <- small.IUCN$EOO #456
small.AOO <- small.IUCN$AOO #49848.9

small_observed <-
  dplyr::select(
    T_ornatus_Ec,
    decimalLatitude,
    decimalLongitude,
    coordinateUncertaintyInMeters,
    species
  )
```

# 2. meters_to_decdeg function
```{r uncertainty from meter to radian degrees}
#NA as Zero
small_naZero <-
  meters_to_decdeg(
    T_ornatus_Ec,
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    distance = "coordinateUncertaintyInMeters",
    na_action = "NA as 0"
  )

small_naZero <-
  cbind(T_ornatus_Ec, small_naZero)

small_naZero <- dplyr::select(
  small_naZero,
  decimalLatitude,
  decimalLongitude,
  lon_uncertainty,
  lat_uncertainty,
  species
)

#NA as Mean
small_naMean <-
  meters_to_decdeg(
    T_ornatus_Ec,
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    distance = "coordinateUncertaintyInMeters",
    na_action = "NA as mean"
  )

small_naMean <-
  cbind(T_ornatus_Ec, small_naMean)

small_naMean <- dplyr::select(
  small_naMean,
  decimalLatitude,
  decimalLongitude,
  lon_uncertainty,
  lat_uncertainty,
  species
)

#NA as NA
small_naNA <-
  meters_to_decdeg(
    T_ornatus_Ec,
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    distance = "coordinateUncertaintyInMeters",
    na_action = "NA as NA"
  )

small_naNA <-
  cbind(T_ornatus_Ec, small_naNA)

#removes the NA cells to use function random_geo_range with uses lat/lon uncertainty
small_naNA <-
  dplyr::filter(small_naNA, !is.na(coordinateUncertaintyInMeters))

small_naNA <- dplyr::select(
  small_naNA,
  decimalLatitude,
  decimalLongitude,
  lon_uncertainty,
  lat_uncertainty,
  species
)
```

# 3. Using the random occurrences in land metrics with random_geo_range

## `NA as Mean`
```{r small_naMean_geo_range}
#1000
#----
small_naMean_geo_range_1000 <-
  random_geo_range(
    1000,
    small_naMean,
    taxa_col = "species",
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    lon_uncertainty = "lon_uncertainty",
    lat_uncertainty = "lat_uncertainty",
    country_map = land,
    exclude.area = T
  )
small_naMean_geo_range_1000$NA_action <- "NA as Mean"
#----
#100
small_naMean_geo_range_100 <-
  random_geo_range(
    100,
    small_naMean,
    taxa_col = "species",
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    lon_uncertainty = "lon_uncertainty",
    lat_uncertainty = "lat_uncertainty",
    country_map = land,
    exclude.area = T
  )
small_naMean_geo_range_100$NA_action <- "NA as Mean"

#Z-stat
#100.EOO --> -4.783784
(small.EOO - mean(small_naMean_geo_range_100$EOO)) / sd(small_naMean_geo_range_100$EOO)

#100.AOO --> -7.764154 
(small.AOO - mean(small_naMean_geo_range_100$AOO)) / sd(small_naMean_geo_range_100$AOO)

#EOO.1K --> -4.329659
(small.EOO - mean(small_naMean_geo_range_1000$EOO)) / sd(small_naMean_geo_range_1000$EOO)

#AOO.1K --> -7.745828
(small.AOO - mean(small_naMean_geo_range_1000$AOO)) / sd(small_naMean_geo_range_1000$AOO)
```

## `Na as Zero`
```{r small_naZero_geo_range}
#1000
#----
small_naZero_geo_range_1000 <-
  random_geo_range(
    1000,
    small_naZero,
    taxa_col = "species",
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    lon_uncertainty = "lon_uncertainty",
    lat_uncertainty = "lat_uncertainty",
    country_map = land,
    exclude.area = T
  )
small_naZero_geo_range_1000$NA_action <- "NA as Zero"

#100
#----
small_naZero_geo_range_100 <-
  random_geo_range(
    100,
    small_naZero,
    taxa_col = "species",
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    lon_uncertainty = "lon_uncertainty",
    lat_uncertainty = "lat_uncertainty",
    country_map = land,
    exclude.area = T
  )
small_naZero_geo_range_100$NA_action <- "NA as Zero"

#Z-stat
## 100.EOO  --> -6.523951
(small.EOO - mean(small_naZero_geo_range_100$EOO)) / sd(small_naZero_geo_range_100$EOO)

## 100.AOO --> -6.965812
(small.AOO - mean(small_naZero_geo_range_100$nAOO)) / sd(small_naZero_geo_range_100$AOO)

## EOO.1K --> -6.283048
(small.EOO - mean(small_naZero_geo_range_1000$EOO)) / sd(small_naZero_geo_range_1000$EOO)

## AOO.1K --> -7.914024
(small.AOO - mean(small_naZero_geo_range_1000$AOO)) / sd(small_naZero_geo_range_1000$AOO)

```

## `NA as NA`
```{r small_naNA_geo_range}
#1000
#----
small_naNA_geo_range_1000 <-
  random_geo_range(
    1000,
    small_naNA,
    taxa_col = "species",
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    lon_uncertainty = "lon_uncertainty",
    lat_uncertainty = "lat_uncertainty",
    country_map = land,
    exclude.area = T
  )
small_naNA_geo_range_1000$NA_action <- "NA as NA"

#----
#100
small_naNA_geo_range_100 <-
  random_geo_range(
    100,
    small_naNA,
    taxa_col = "species",
    lat_col = "decimalLatitude",
    lon_col = "decimalLongitude",
    lon_uncertainty = "lon_uncertainty",
    lat_uncertainty = "lat_uncertainty",
    country_map = land,
    exclude.area = T
  )
small_naNA_geo_range_100$NA_action <- "NA as NA"

#Z-stat
## 100.EOO --> -3.543685
(small.EOO - mean(small_naNA_geo_range_100$EOO)) / sd(small_naNA_geo_range_100$EOO)

## 100.AOO --> -5.409427
(small.AOO - mean(small_naNA_geo_range_100$AOO)) / sd(small_naNA_geo_range_100$AOO)

## EOO.1K --> -3.585068
(small.EOO - mean(small_naNA_geo_range_1000$EOO)) / sd(small_naNA_geo_range_1000$EOO)

## AOO.1K --> -6.130783
(small.AOO - mean(small_naNA_geo_range_1000$AOO)) / sd(small_naNA_geo_range_1000$AOO)
```

# Save Results as CSV
```{r csv iterations}
save(
  small_naMean_geo_range_100,
  small_naZero_geo_range_100,
  small_naNA_geo_range_100,
  file = "../Results/Ec_results/Ec_100georanges.rda"
)

save(
  small_naMean_geo_range_1000,
  small_naZero_geo_range_1000,
  small_naNA_geo_range_1000,
  file = "../Results/Ec_results/Ec_1000georanges.rda"
)

```

```{r EOO iteration plots echo=FALSE, fig.width = 10, fig.height= 15}
library(ggplot2)
library(gridExtra)
library(grid)
library(ggrepel)

theme_set(theme_gray())
theme(plot.title = element_text(hjust = 0.5))

load("../Results/Ec_100georanges.rda")

load("../Results/Ec_1000georanges.rda")

EC_1000georanges <- rbind(naMean_geo_range_1000,
                          naZero_geo_range_1000,
                          naNA_geo_range_1000
)

EC_100georanges <- rbind(naMean_geo_range_100,
                         naZero_geo_range_100,
                         naNA_geo_range_100
)

EOO.1000 <-
  ggplot(EC_1000georanges, aes(x = EOO, fill = as.factor(NA_action)))  +
  theme_bw() +
  scale_fill_discrete(name = "NA Parameters", guide = FALSE) +
  geom_histogram(alpha = 0.6,
                 position = 'identity') +
  geom_vline(aes(xintercept = 248174.8),
             #Only NA occ EOO
             colour = "black",
             linetype = 2) +
  geom_vline(xintercept = large.EOO, colour = "red") #observed EOO

AOO.1000 <-
  ggplot(EC_100georanges, aes(x = AOO, color = as.factor(NA_action)))  +
  theme_bw() +
  
  scale_color_discrete(name = "NA Parameters") +
  geom_histogram(alpha = 0.6,
                 position = 'identity') +
  geom_vline(aes(xintercept = 744),
             colour = "black",
             linetype = 2,) +
  geom_vline(xintercept = large.AOO, colour = "red")

EOO.100 <-
  ggplot(EC_100georanges, aes(x = EOO, fill = as.factor(NA_action)))  +
  theme_bw() +
  scale_fill_discrete(name = "NA Parameters", guide = FALSE) +
  geom_histogram(alpha = 0.6,
                 position = 'identity') +
  geom_vline(aes(xintercept = 248174.8),
             #Only NA occ EOO
             colour = "black",
             linetype = 2) +
  geom_vline(xintercept = large.EOO, colour = "red") #observed EOO

AOO.100 <-
  ggplot(EC_100georanges, aes(x = AOO, color = as.factor(NA_action)))  +
  theme_bw() +
  
  scale_color_discrete(name = "NA Parameters") +
  geom_histogram(alpha = 0.6,
                 position = 'identity') +
  geom_vline(aes(xintercept = 744),
             colour = "black",
             linetype = 2,) +
  geom_vline(xintercept = large.AOO, colour = "red")

EC_plot <-
  plot_grid(EOO.1000,
            AOO.1000,
            EOO.100,
            AOO.100,
            ncol = 2,
            rel_widths = c(1, 1.6))

title <- ggdraw() +
  draw_label(
    "T. ornatus added uncertainty occurrences' spatial metric with different NA_action parameters in Ecuador",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(# add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7))

plot_grid(title,
          EC_plot,
          ncol = 1,
          # rel_heights values control vertical title margins
          rel_heights = c(0.1, 1))

cowplot::ggsave(
  filename = "Ec_results/EC_plot_grid.png",
  width = 8,
  height = 4,
  units = "in",
  dpi = 96
)
```


